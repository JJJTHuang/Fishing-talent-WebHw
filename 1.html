<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Canva_hunting_fish</title>
    <style>
        body {
            text-align: center;
            background: #000;
        }

        #canvas {
            background-image: url('img/game_bg_2_hd.jpg')
        }
    </style>
    <script src="jquery.js"></script>
    <script src="js/LoadResources.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/Spirit.js"></script>
    <script src="js/Fish.js"></script>
    <script src="js/Cannon.js"></script>
    <script src="js/Bullet.js"></script>
    <script src="js/Button.js"></script>
    <script src="js/Coin.js"></script>
    <script>
        window.onload = async function () {

            let audio = new Audio()
            audio.src = 'snd/coin.wav'

            //ÂàõÂª∫Canvas
            let oC = document.getElementById('canvas'),
                gd = oC.getContext('2d'),
                W = oC.width, H = oC.height,
                C_flag = false,//Â≠êÂºπÂèëÂ∞Ñ,ÁÇÆÂ°îÁöÑÂä®ÁîªÊ†áÂøó
                Username = '',//Áî®Êà∑Âêç
                Start = false,//Ê∏∏ÊàèÂºÄÂßãÊ†áÂøó
                User_score = 0,//Áî®Êà∑ÂæóÂàÜ
                FishType = ['ÊçïËé∑ÈúπÈõ≥ÊóãÈ£éÂ∞èÈáëÈ±º', 'ÊçïËé∑Êó†ÊïåÊâòÂ∞ºÂ∞è‰∏ëÈ±º', 'ÊçïËé∑Êàë‰πü‰∏çÁü•Âè´Âï•Â∞èÁ∫¢È±º', 'ÊçïËé∑ËÉñÁå™Â∞èËìùËâ≤È±º', 'ÊçïËé∑ËÉñÁå™Â§ßÊ≤≥Ë±öüê°'],//È±ºÂÑøÁöÑÁßçÁ±ª
                Score_fishes = [0, 0, 0, 0, 0, 0],//‰∏çÂêåÁ±ªÂûãÈ±ºÂÑøÊï∞Èáè
                ShowText = true,//Ê¨¢ËøéÊ†áÈ¢òÊòæÁ§∫
                fontsize = 20,//Ê¨¢ËøéÊ†áËØ≠Â≠ó‰ΩìÂ§ßÂ∞è
                Score_fishes_y = [20,40,60,80,100]

            try {
                //ËØ∑Ê±ÇËµÑÊ∫ê
                await LoadR()//ÂºÇÊ≠•ËØ∑Ê±Ç,ÊúâÂèØËÉΩÂ§±Ë¥•,ÊâÄ‰ª•Ë¶Åcatch‰∏Ä‰∏ã

                console.log(_g_resource)
            } catch (e) {
                alert('Âä†ËΩΩÂ§±Ë¥•,ËØ∑Âà∑Êñ∞„ÄÇ')
                throw e
            }

            Username = window.prompt('ËØ∑ËæìÂÖ•ÊÇ®ÁöÑÂêçÁß∞(‰æãÂ¶Ç:ÂéãÂäõÂ±±Â§ß208‰∏ñ),Ê≥®ÊÑè!ÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫,‰∏çÁÑ∂‰Ω†ËØïËØïÁúã:')
            Username ? Start = true : ''

            let timer = setTimeout(() => {
                ShowText = false
            }, 3000);

            //ÁîªÈ±ºÂÑø
            let fishes = []
            setInterval(() => {
                let fish = new Fish(rnd(1, 6))
                fish.y = rnd(1, H)
                if (Math.random < 0.1) {
                    // let Shark = _g_resource[]
                }
                if (Math.random() < 0.5) {
                    fish.x = -50
                } else {
                    fish.x = W + 50
                    fish.rotation = -90
                    //È±ºÂΩ±ÁøªËΩ¨  
                    fish.scaleY = -1
                }
                fishes.push(fish)
            }, 500)

            //Áîª‰∏Ä‰∏™bottom_bar
            let data_bar = _g_resource['bottom'].bottom_bar
            let bottom_bar = new Spirit({
                img: data_bar.img,
                sx: data_bar.frame.x, sy: data_bar.frame.y,
                w: data_bar.frame.w, h: data_bar.frame.h
            })
            bottom_bar.x = 400
            bottom_bar.y = 566

            //Áîª‰∏Ä‰∏™ÁÇÆÂ°î
            let cannon = new Cannon(1)
            cannon.x = 450
            cannon.y = 566
            cannon.max_tick = 3;

            //--------------------------‰∫ã‰ª∂ÁõëÂê¨-----------------------------

            //ÁÇÆÂ°îÈöèÈº†Ê†áËΩ¨Âä®
            oC.onmousemove = ((ev) => {
                let x = ev.offsetX - cannon.x, y = ev.offsetY - cannon.y
                cannon.rotation = Math.atan2(y, x) * 180 / Math.PI + 90;
            })

            //ÂΩìÈº†Ê†áÁÇπÂáªÁöÑÊó∂ÂÄô,ÂèëÂ∞ÑÂ≠êÂºπ
            let Bullets = []
            oC.onclick = (ev => {
                //ÂèëÂ∞ÑÂ≠êÂºπ
                let bullet = new Bullet(`${cannon.type}`)
                bullet.x = cannon.x
                bullet.y = cannon.y
                bullet.rotation = cannon.rotation
                Bullets.push(bullet)
                C_flag = true
            })

            //ÁÇÆÂ°îÁ±ªÂûãÂàáÊç¢
            oC.onmousedown = (ev => {
                if (cannon.type > 1) {
                    if (Button_minus.checkDown(ev.offsetX, ev.offsetY)) {
                        cannon.setType(--cannon.type)
                    }
                }

                if (cannon.type < 7) {
                    if (Button_plus.checkDown(ev.offsetX, ev.offsetY)) {
                        cannon.setType(++cannon.type)
                    }
                }
            })

            oC.onmouseup = (ev => {
                Button_plus.checkUp(ev.offsetX, ev.offsetY)
                Button_minus.checkUp(ev.offsetX, ev.offsetY)
            })

            // ------------------‰∫ã‰ª∂Ê£ÄÊµãEND------------------

            //ÁîªÊåâÈíÆ
            let Button_minus = new Button('minus'), Button_plus = new Button('plus')

            Button_minus.x = cannon.x - 60
            Button_plus.x = cannon.x + 60
            Button_plus.y = Button_minus.y = cannon.y + 15

            //ÈáëÂ∏ÅÊï∞ÁªÑ
            let Coins = []

            Start ? nextFrame(gd) : ''

            function nextFrame(gd) {
                requestAnimationFrame(next)

                function next() {
                    //Ê∏ÖÁ©∫ÁîªÂ∏É
                    gd.clearRect(0, 0, oC.width, oC.height)

                    //Áâ©‰ΩìÁöÑÁßªÂä®
                    if (C_flag) {
                        cannon.nextFrame()
                        if (cannon.frame === cannon.max_frame) {
                            cannon.frame = 0
                            C_flag = false
                        }
                    }

                    //Á¢∞ÊíûÊ£ÄÊµã
                    Bullets.forEach((bullet, b_index) => {
                        fishes.forEach((fish, f_index) => {
                            if (bullet.Collision(fish)) {

                                Score_fishes[fish.type]++

                                fishes.splice(f_index, 1)
                                Bullets.splice(b_index, 1)

                                let coin = new Coin(2)
                                coin.x = fish.x
                                coin.y = fish.y
                                coin.max_frame = 10
                                coin.max_tick = 3
                                Coins.push(coin)

                                audio.play()
                            }
                        })
                    })

                    //ÁªòÂà∂
                    Coins.forEach((coin, index) => {
                        coin.draw(gd)
                        coin.nextFrame()
                        if (coin.y > 0) {
                            coin.y -= 5
                            coin.y < 1 ? Coins.splice(index, 1) : ''
                        }
                    })

                    fishes.forEach((fish, f_index) => {
                        fish.draw(gd)
                        fish.move()
                        fish.nextFrame()

                        //ÂΩìfishË∂ÖÂá∫‰∫ÜÁîªÂ∏É,Âà†Èô§ËøôÊù°È±ºÂÑø
                        if (
                            (fish.rotation >= 90 && fish.x > 600 && fish.outOfCanvas(W, H)) ||
                            (fish.rotation <= -90 && fish.x < 100 && fish.outOfCanvas(W, H))
                        ) {
                            fishes.splice(f_index, 1)
                        }
                    })

                    Bullets.forEach((bullet, b_index) => {
                        bullet.draw(gd)
                        bullet.move()
                        if (
                            bullet.outOfCanvas(W, H)
                        ) {
                            Bullets.splice(b_index, 1)
                        }
                    })

                    bottom_bar.draw(gd)
                    cannon.draw(gd)
                    Button_minus.draw(gd)
                    Button_plus.draw(gd)

                    FishType.forEach((fish,index) => {
                        gd.font = `${fontsize/1.8}px Georgia`
                        gd.fillStyle = '#fff'
                        gd.fillText(`${fish}:${Score_fishes[index+1]}`,0,`${Score_fishes_y[index]}`)
                    })

                    if (ShowText) {
                        gd.font = `${fontsize}px Georgia`
                        gd.fillStyle = '#fff'
                        gd.fillText(`‰Ω†Â•Ω,‰∫∫ËßÅ‰∫∫Áà±,Ëä±ËßÅËä±ÂºÄ,ËΩ¶ËßÅËΩ¶ÁàÜËÉéÁöÑ`, 180, 300)
                        gd.font = `${fontsize * 2.5}px Georgia`
                        gd.fillText(`${Username}`,520,300)
                        gd.font = `${fontsize}px Georgia`
                    }

                    requestAnimationFrame(next)
                }
            }
        }
    </script>
</head>

<body>
    <canvas width="800" height="600" id="canvas"></canvas>
    <audio src="snd/Matteo-Panama.mp3" autoplay loop></audio>
</body>

</html>